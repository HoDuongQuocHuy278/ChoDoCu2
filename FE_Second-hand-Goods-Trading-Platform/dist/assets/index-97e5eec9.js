import{_ as U,a as x,y as V,c as d,h as g,t as l,b as n,F as L,r as R,g as _,n as M,w as O,j as W,d as B,e as K,f as j,o as h,p as D,k as F}from"./index-01669123.js";import{f as m}from"./imageHelper-6b936e79.js";import"./config-162ba8a8.js";const J={name:"SanPham",data(){return{API_BASE_URL:"/api/client",CART_STORAGE_KEY:"fe_marketplace_cart",product:null,related:[],images:[],isLoading:!0,errorMessage:"",liked:!1,quantity:1}},computed:{productId(){var t;return(t=this.$route.params)==null?void 0:t.id}},watch:{"$route.params.id"(){this.fetchProduct(),window.scrollTo({top:0,behavior:"smooth"})}},mounted(){this.fetchProduct()},methods:{async fetchProduct(){var t,s;if(this.productId){this.isLoading=!0,this.errorMessage="",this.quantity=1;try{const{data:r}=await x.get(`${this.API_BASE_URL}/san-pham/${this.productId}`),i=(r==null?void 0:r.data)||r;this.product=i,this.buildImages(i),await this.fetchRelated(i==null?void 0:i.id)}catch(r){console.error(r),this.errorMessage=((s=(t=r==null?void 0:r.response)==null?void 0:t.data)==null?void 0:s.message)||"Không thể tải thông tin sản phẩm.",this.product=null}finally{this.isLoading=!1}}},buildImages(t){const s=[];if(t!=null&&t.image&&s.push(m(t.image)),Array.isArray(t==null?void 0:t.images)&&s.push(...t.images.map(r=>{const i=typeof r=="string"?r:r.url;return m(i)})),!s.length&&(t!=null&&t.hinh_anh))try{const r=typeof t.hinh_anh=="string"&&t.hinh_anh.trim().startsWith("[")?JSON.parse(t.hinh_anh):t.hinh_anh;Array.isArray(r)?s.push(...r.filter(i=>typeof i=="string"&&i).map(i=>m(i))):typeof r=="string"&&r&&s.push(m(r))}catch{typeof t.hinh_anh=="string"&&t.hinh_anh&&s.push(m(t.hinh_anh))}s.length||s.push(this.fallbackImg),this.images=Array.from(new Set(s)),this.activeImage=this.images[0]},async fetchRelated(t){if(!t){this.related=[];return}try{const{data:s}=await x.get(`${this.API_BASE_URL}/san-pham/${t}/similar`),r=(s==null?void 0:s.data)||s||[];this.related=Array.isArray(r)?r.map(i=>{let e=i.image||null;if(!e&&Array.isArray(i.images)&&i.images.length>0&&(e=i.images[0]),!e&&i.hinh_anh)try{const o=typeof i.hinh_anh=="string"&&i.hinh_anh.trim().startsWith("[")?JSON.parse(i.hinh_anh):i.hinh_anh;Array.isArray(o)&&o.length>0?e=o[0]:typeof o=="string"&&o&&(e=o)}catch{typeof i.hinh_anh=="string"&&i.hinh_anh&&(e=i.hinh_anh)}return{id:i.id,name:i.ten_san_pham||i.name,price:i.gia||i.price,discount:i.discount||0,image:e||this.fallbackImg}}):[]}catch(s){console.warn("Không thể tải sản phẩm liên quan",s),this.related=[]}},finalPrice(t){const s=Number((t==null?void 0:t.price)||0),r=Number((t==null?void 0:t.discount)||0);return s*(1-r/100)},formatCurrency(t){return(Number(t)||0).toLocaleString("vi-VN")+" ₫"},onImgError(t){if(t.target.dataset.fallbackSet==="true"){t.target.style.display="none";return}t.target.dataset.fallbackSet="true",t.target.src=this.fallbackImg,t.target.src=this.fallbackImg,t.target.onerror=null},fixImage(t){return m(t)},updateQty(t){var r;const s=this.quantity+t;this.quantity=Math.min(Math.max(s,1),Number(((r=this.product)==null?void 0:r.quantity)||99))},addToCart(){var i;if(!this.product)return;const t=localStorage.getItem(this.CART_STORAGE_KEY),s=t?JSON.parse(t):[],r=Array.isArray(s)?s.findIndex(e=>e.id===this.product.id):-1;r>-1?s[r].quantity=Math.min(99,Number(s[r].quantity||0)+this.quantity):s.push({id:this.product.id,name:this.product.name,price:Number(this.finalPrice(this.product)),quantity:this.quantity,image:this.images[0],category:((i=this.product.category)==null?void 0:i.name)||this.product.category||"",seller_id:this.product.seller_id||this.product.user_id||this.product.nguoi_dang_id,user_id:this.product.user_id||this.product.nguoi_dang_id||this.product.seller_id}),localStorage.setItem(this.CART_STORAGE_KEY,JSON.stringify(s)),window.dispatchEvent(new CustomEvent("cart-updated")),typeof window<"u"&&(window!=null&&window.$toast)?window.$toast.success("Đã thêm vào giỏ hàng!"):alert("Đã thêm vào giỏ hàng!")},buyNow(){this.product&&this.$router.push({name:"checkout",query:{product_id:this.product.id,quantity:this.quantity}})},toggleFavourite(){this.liked=!this.liked},async chatWithSeller(){var r,i,e,o,p,b,f;const t=((r=this.product)==null?void 0:r.seller_id)||((i=this.product)==null?void 0:i.khach_hang_id)||((o=(e=this.product)==null?void 0:e.seller)==null?void 0:o.id);if(!t){this.showToast("Không tìm thấy thông tin người bán","error");return}const s=localStorage.getItem("key_client");if(!s){confirm("Bạn cần đăng nhập để nhắn tin. Bạn có muốn chuyển đến trang đăng nhập?")&&this.$router.push("/dang-nhap");return}try{const{data:a}=await x.post(`${this.API_BASE_URL}/chat/create-or-get`,{seller_id:t,product_id:this.productId},{headers:{Authorization:`Bearer ${s}`}});if(a!=null&&a.status&&((p=a==null?void 0:a.data)!=null&&p.chat_id))this.$router.push(`/chat/${a.data.chat_id}`);else throw new Error("Không thể tạo cuộc trò chuyện")}catch(a){console.error("Lỗi khi tạo chat:",a);const y=((f=(b=a==null?void 0:a.response)==null?void 0:b.data)==null?void 0:f.message)||"Không thể tạo cuộc trò chuyện. Vui lòng thử lại.";this.showToast(y,"error")}},showToast(t,s="info"){typeof window<"u"&&(window!=null&&window.$toast)?window.$toast[s](t):alert(t)}}},u=t=>(D("data-v-635dd8de"),t=t(),F(),t),G={key:0,class:"product-detail container py-4"},Q={key:0,class:"alert alert-danger"},Y={key:1,class:"row g-4"},z={class:"col-lg-6"},X={class:"gallery card shadow-sm"},H={class:"ratio ratio-4x3"},Z=["src","alt"],$={class:"thumb-list mt-3"},tt=["onClick"],st=["src","alt"],et={class:"col-lg-6"},nt={class:"info card shadow-sm"},it={class:"card-body"},rt={class:"d-flex align-items-start justify-content-between"},ot={key:0,class:"badge bg-success-subtle text-success mb-2"},ct={class:"fw-bold"},at={class:"text-muted mb-2"},lt={class:"price-box my-3"},dt={class:"price"},ht={key:0,class:"text-muted text-decoration-line-through ms-2"},ut={key:1,class:"badge bg-danger-subtle text-danger ms-2"},gt={class:"meta list-unstyled small"},_t=u(()=>n("strong",null,"Mã sản phẩm:",-1)),mt=u(()=>n("strong",null,"Tình trạng:",-1)),pt=u(()=>n("strong",null,"Số lượng còn:",-1)),bt={class:"d-flex align-items-center justify-content-between"},ft=u(()=>n("strong",null,"Đăng bởi:",-1)),yt=u(()=>n("i",{class:"bx bx-message-rounded-dots"},null,-1)),vt=u(()=>n("span",null,"Nhắn tin",-1)),xt=[yt,vt],wt=u(()=>n("strong",null,"Địa điểm:",-1)),kt={class:"description mt-3"},It={class:"d-flex align-items-center gap-3 my-4 flex-wrap"},St={class:"qty-control"},Ct=["disabled"],At=["max"],Nt=u(()=>n("i",{class:"bx bx-cart-alt me-1"},null,-1)),qt=u(()=>n("i",{class:"bx bx-message-rounded-dots me-1"},null,-1)),Et=j('<div class="card bg-light border-0" data-v-635dd8de><div class="card-body d-flex flex-column gap-2" data-v-635dd8de><div data-v-635dd8de><i class="bx bx-check-circle text-success me-2" data-v-635dd8de></i> Được kiểm duyệt bởi Chợ Đồ Cũ</div><div data-v-635dd8de><i class="bx bx-shield-quarter text-success me-2" data-v-635dd8de></i> Hỗ trợ hoàn tiền nếu không đúng mô tả</div><div data-v-635dd8de><i class="bx bx-chat text-success me-2" data-v-635dd8de></i> Chat với người bán để thương lượng giá</div></div></div>',1),Tt={key:2,class:"mt-5"},Pt={class:"d-flex justify-content-between align-items-center mb-3"},Lt=u(()=>n("h4",{class:"fw-semibold m-0"},"Sản phẩm tương tự",-1)),Rt={class:"row g-3"},Mt={class:"related-card card h-100"},Bt=["src","alt"],Kt={class:"card-body"},Ut={class:"text-truncate"},Vt={class:"mb-2 text-muted small"},Ot={key:1,class:"d-flex justify-content-center align-items-center py-5"},Wt=u(()=>n("div",{class:"spinner-border text-success",role:"status"},[n("span",{class:"visually-hidden"},"Đang tải...")],-1)),jt=[Wt];function Dt(t,s,r,i,e,o){var b,f,a,y,w,k,I,S,C,A,N,q,E,T;const p=V("router-link");return e.isLoading?(h(),d("div",Ot,jt)):(h(),d("div",G,[e.errorMessage?(h(),d("div",Q,[g(l(e.errorMessage)+" ",1),n("button",{type:"button",class:"btn btn-sm btn-outline-light ms-2",onClick:s[0]||(s[0]=(...c)=>o.fetchProduct&&o.fetchProduct(...c))},"Thử lại")])):e.product?(h(),d("div",Y,[n("div",z,[n("div",X,[n("div",H,[n("img",{src:t.activeImage,class:"main-img",alt:e.product.name,onError:s[1]||(s[1]=c=>o.onImgError(c))},null,40,Z)]),n("div",$,[(h(!0),d(L,null,R(e.images,(c,v)=>(h(),d("button",{key:v,type:"button",class:M(["thumb-btn",{active:c===t.activeImage}]),onClick:P=>t.activeImage=c},[n("img",{src:t.fixImageUrl(c)||t.getDefaultProductImage(),alt:e.product.name,onError:s[2]||(s[2]=P=>o.onImgError(P))},null,40,st)],10,tt))),128))])])]),n("div",et,[n("div",nt,[n("div",it,[n("div",rt,[n("div",null,[e.product.conditionLabel?(h(),d("span",ot,l(e.product.conditionLabel),1)):_("",!0),n("h2",ct,l(e.product.name),1),n("p",at,l(((b=e.product.category)==null?void 0:b.name)||e.product.category||"Danh mục khác"),1)]),n("button",{class:"btn btn-outline-danger btn-sm",type:"button",onClick:s[3]||(s[3]=(...c)=>o.toggleFavourite&&o.toggleFavourite(...c))},[n("i",{class:M(e.liked?"bx bxs-heart":"bx bx-heart")},null,2)])]),n("div",lt,[n("span",dt,l(o.formatCurrency(o.finalPrice(e.product))),1),e.product.discount?(h(),d("span",ht,l(o.formatCurrency(e.product.price)),1)):_("",!0),e.product.discount?(h(),d("span",ut," -"+l(e.product.discount)+"% ",1)):_("",!0)]),n("ul",gt,[n("li",null,[_t,g(" #"+l(e.product.slug||e.product.id),1)]),n("li",null,[mt,g(" "+l(e.product.conditionLabel||"Đang cập nhật"),1)]),n("li",null,[pt,g(" "+l(e.product.quantity||e.product.stock||1),1)]),n("li",bt,[n("span",null,[ft,g(" "+l(((f=e.product.seller)==null?void 0:f.name)||((a=e.product.khach_hang)==null?void 0:a.ho_va_ten)||"Người bán ẩn danh"),1)]),(y=e.product)!=null&&y.seller_id||(w=e.product)!=null&&w.khach_hang_id||(I=(k=e.product)==null?void 0:k.seller)!=null&&I.id?(h(),d("button",{key:0,class:"btn btn-sm btn-success d-flex align-items-center gap-1 ms-2",type:"button",onClick:s[4]||(s[4]=(...c)=>o.chatWithSeller&&o.chatWithSeller(...c)),title:"Nhắn tin trực tiếp với người bán"},xt)):_("",!0)]),n("li",null,[wt,g(" "+l(e.product.location||e.product.dia_chi||"Liên hệ người bán"),1)])]),n("p",kt,l(e.product.description||"Người bán chưa cung cấp mô tả chi tiết."),1),n("div",It,[n("div",St,[n("button",{class:"btn btn-sm btn-light",type:"button",onClick:s[5]||(s[5]=c=>o.updateQty(-1)),disabled:e.quantity<=1},"−",8,Ct),O(n("input",{type:"number",min:"1",max:e.product.quantity||99,"onUpdate:modelValue":s[6]||(s[6]=c=>e.quantity=c)},null,8,At),[[W,e.quantity,void 0,{number:!0}]]),n("button",{class:"btn btn-sm btn-light",type:"button",onClick:s[7]||(s[7]=c=>o.updateQty(1))},"＋")]),n("button",{class:"btn btn-success flex-grow-1 flex-sm-grow-0",type:"button",onClick:s[8]||(s[8]=(...c)=>o.addToCart&&o.addToCart(...c))},[Nt,g(" Thêm vào giỏ ")]),n("button",{class:"btn btn-outline-primary flex-grow-1 flex-sm-grow-0",type:"button",onClick:s[9]||(s[9]=(...c)=>o.buyNow&&o.buyNow(...c))}," Mua ngay "),(S=e.product)!=null&&S.seller_id||(C=e.product)!=null&&C.khach_hang_id||(N=(A=e.product)==null?void 0:A.seller)!=null&&N.id?(h(),d("button",{key:0,class:"btn btn-success flex-grow-1 flex-sm-grow-0",type:"button",onClick:s[10]||(s[10]=(...c)=>o.chatWithSeller&&o.chatWithSeller(...c)),title:"Chat với người bán"},[qt,g(" Chat với người bán ")])):_("",!0)]),Et])])])])):_("",!0),e.related.length?(h(),d("section",Tt,[n("div",Pt,[Lt,B(p,{to:`/danh-sach-san-pham?category=${((E=(q=e.product)==null?void 0:q.category)==null?void 0:E.slug)||((T=e.product)==null?void 0:T.category)}`,class:"btn btn-link btn-sm"},{default:K(()=>[g(" Xem thêm ")]),_:1},8,["to"])]),n("div",Rt,[(h(!0),d(L,null,R(e.related,c=>(h(),d("article",{key:c.id,class:"col-6 col-md-4 col-lg-3"},[n("div",Mt,[n("img",{src:t.fixImageUrl(c.image)||t.getDefaultProductImage(),class:"card-img-top",alt:c.name,onError:s[11]||(s[11]=v=>o.onImgError(v))},null,40,Bt),n("div",Kt,[n("h6",Ut,l(c.name),1),n("p",Vt,l(o.formatCurrency(o.finalPrice(c))),1),B(p,{class:"btn btn-outline-primary btn-sm w-100",to:`/san-pham/${c.id}`},{default:K(()=>[g(" Xem chi tiết ")]),_:2},1032,["to"])])])]))),128))])])):_("",!0)]))}const Qt=U(J,[["render",Dt],["__scopeId","data-v-635dd8de"]]);export{Qt as default};
